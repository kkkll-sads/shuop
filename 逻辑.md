# æ ‘äº¤æ‰€ï¼ˆTreeExï¼‰åç«¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¼€å‘æ–‡æ¡£ï¼ˆæœ€ç»ˆæ•´åˆç‰ˆï¼‰

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v9.0 Final  
**æ›´æ–°æ—¥æœŸï¼š** 2025-12-12  
**é€‚ç”¨æŠ€æœ¯æ ˆï¼š** PHP (ThinkPHP/Laravel) + MySQL 5.7+ + Redis  
**æ ¸å¿ƒæ¶æ„ï¼š** é¢„çº¦æ’®åˆå¼•æ“ + ç®—åŠ›åŠ æ³¨æœºåˆ¶ + èµ„é‡‘å››åº“éš”ç¦» + æƒç›Šåˆ†çº¢å…œåº• + æ—§èµ„äº§è§£é”

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“è®¾è®¡](#ä¸€æ•°æ®åº“è®¾è®¡)
2. [æ ¸å¿ƒä¸šåŠ¡æ¨¡å—](#äºŒæ ¸å¿ƒä¸šåŠ¡æ¨¡å—)
3. [ç®—åŠ›ç»æµæ¨¡å‹](#ä¸‰ç®—åŠ›ç»æµæ¨¡å‹)
4. [èµ„é‡‘æµè½¬é—­ç¯](#å››èµ„é‡‘æµè½¬é—­ç¯)
5. [æ—§èµ„äº§è§£é”æœºåˆ¶](#äº”æ—§èµ„äº§è§£é”æœºåˆ¶)
6. [å®šæ—¶ä»»åŠ¡](#å…­å®šæ—¶ä»»åŠ¡)
7. [å¼€å‘æ³¨æ„äº‹é¡¹](#ä¸ƒå¼€å‘æ³¨æ„äº‹é¡¹)

---

## ä¸€ã€æ•°æ®åº“è®¾è®¡

### 1.1 ç”¨æˆ·èµ„äº§è¡¨ï¼ˆusersï¼‰- å­—æ®µä¸šåŠ¡é‡å®šä¹‰

**é‡è¦ï¼š** æ— éœ€ä¿®æ”¹ç‰©ç†å­—æ®µåï¼Œä»…ä¿®æ”¹ä»£ç ä¸šåŠ¡é€»è¾‘æ˜ å°„

```sql
-- å­—æ®µä¸šåŠ¡å«ä¹‰æ˜ å°„ï¼š
-- available_money  â†’ ã€ä¾›åº”é“¾ä¸“é¡¹é‡‘ã€‘ï¼ˆåªè¿›ä¸å‡ºï¼Œç”¨äºæŠ¢è´­å†»ç»“ï¼Œæ¥æºï¼šå……å€¼ï¼‰
-- withdraw_money   â†’ ã€å¯è°ƒåº¦æ”¶ç›Šã€‘ï¼ˆå¯æç°ï¼Œæ¥æºï¼šå–è´§å›æ¬¾/ä½£é‡‘ï¼‰
-- service_money    â†’ ã€ç¡®æƒé‡‘ã€‘ï¼ˆæ‰‹ç»­è´¹ï¼Œæ¥æºï¼šåˆ’è½¬ï¼‰
-- score            â†’ ã€æ¶ˆè´¹é‡‘ã€‘ï¼ˆå†…å¾ªç¯é€šè¯ï¼Œæ¥æºï¼šäº¤æ˜“åˆ©æ¶¦åˆ†æˆï¼‰
-- ï¼ˆæ–°å¢ï¼‰legacy_frozen â†’ ã€å¾…æ¿€æ´»ç¡®æƒé‡‘ã€‘ï¼ˆæ—§è´¦å†»ç»“é‡‘ï¼Œç”¨äºå…‘æ¢è§£é”åŒ…ï¼‰

-- æ–°å¢å­—æ®µ
ALTER TABLE users 
ADD COLUMN green_hashrate DECIMAL(10,2) DEFAULT 0.00 COMMENT 'ç»¿è‰²ç®—åŠ›ï¼ˆæŠ¢è´­é—¨ç¥¨ï¼‰',
ADD COLUMN legacy_frozen DECIMAL(10,2) DEFAULT 0.00 COMMENT 'å¾…æ¿€æ´»ç¡®æƒé‡‘ï¼ˆæ—§èµ„äº§æŠµæ‰£é¢åº¦ï¼‰';
```

### 1.2 é¢„çº¦/ç”³è´­è®°å½•è¡¨ï¼ˆtrade_reservationsï¼‰- æ ¸å¿ƒæ–°å¢

```sql
CREATE TABLE `trade_reservations` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `session_id` int(11) NOT NULL COMMENT 'åœºæ¬¡IDï¼ˆæ—©/åˆ/æ™šåœºï¼‰',
  `product_id` int(11) DEFAULT '0' COMMENT 'æŒ‡å®šå•†å“IDï¼ˆå¯ä¸º0è¡¨ç¤ºéšæœºåˆ†é…ï¼‰',
  
  -- èµ„é‡‘å†»ç»“
  `freeze_amount` decimal(10,2) NOT NULL COMMENT 'å†»ç»“ã€ä¾›åº”é“¾ä¸“é¡¹é‡‘ã€‘é‡‘é¢',
  
  -- ç®—åŠ›ä¸æƒé‡å­—æ®µï¼ˆåŠ æ³¨æœºåˆ¶æ ¸å¿ƒï¼‰
  `base_hashrate_cost` decimal(10,2) NOT NULL COMMENT 'åŸºç¡€æ¶ˆè€—ç®—åŠ›ï¼ˆé—¨ç¥¨æˆæœ¬ï¼‰',
  `extra_hashrate_cost` decimal(10,2) DEFAULT '0.00' COMMENT 'é¢å¤–åŠ æ³¨ç®—åŠ›ï¼ˆBoostï¼‰',
  `weight` int(11) NOT NULL DEFAULT '100' COMMENT 'ä¸­ç­¾æƒé‡ï¼ˆåŸºæ•°100ï¼ŒåŠ æ³¨æå‡ï¼‰',
  
  -- çŠ¶æ€
  `status` tinyint(1) DEFAULT '0' COMMENT '0:å¾…åŒ¹é… 1:ä¸­ç­¾ 2:æœªä¸­ç­¾',
  `create_time` int(11) DEFAULT NULL,
  `match_time` int(11) DEFAULT NULL COMMENT 'æ’®åˆå®Œæˆæ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_session_status` (`session_id`, `status`),
  KEY `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç«ä»·æ‘˜ç‰Œé¢„çº¦è¡¨';
```

### 1.3 ç”¨æˆ·æŒä»“è¡¨ï¼ˆuser_collectionï¼‰- å­—æ®µæ‰©å±•

```sql
ALTER TABLE user_collection 
ADD COLUMN is_legacy_unlock TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦ä¸ºæ—§èµ„äº§è§£é”åŒ…ï¼ˆ1:æ˜¯ 0:å¦ï¼‰',
ADD COLUMN lock_reason VARCHAR(50) DEFAULT '' COMMENT 'é”å®šåŸå› ï¼ˆå¦‚ MANUAL_STAKEï¼‰';

-- çŠ¶æ€è¯´æ˜ï¼š
-- 1: æŒä»“å¾…å”®
-- 2: æŒ‚å•ä¸­
-- 3: å·²å–å‡º
-- 4: å·²è½¬åˆ†çº¢ï¼ˆæƒç›Šäº¤å‰²ï¼‰
```

### 1.4 å•†å“è¡¨ï¼ˆmarket_productsï¼‰- é˜²ä¼ªå­—æ®µ

```sql
ALTER TABLE market_products 
ADD COLUMN asset_code VARCHAR(50) NOT NULL DEFAULT '' COMMENT 'ç¡®æƒç¼–å·ï¼ˆ37-DATA-YYYYMMDD-xxxxxxï¼‰',
ADD COLUMN tx_hash VARCHAR(64) NOT NULL DEFAULT '' COMMENT 'å­˜è¯æŒ‡çº¹ï¼ˆMD5ä¼ªHashï¼‰';
```

### 1.5 åˆ†çº¢æƒç›ŠèŠ‚ç‚¹è¡¨ï¼ˆuser_dividend_nodesï¼‰- æ–°å»º

```sql
CREATE TABLE `user_dividend_nodes` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `origin_asset_id` int(11) NOT NULL COMMENT 'åŸèµ„äº§IDï¼ˆæ¥æºï¼‰',
  `asset_name` varchar(255) DEFAULT NULL COMMENT 'èµ„äº§åç§°å¿«ç…§',
  
  -- åˆ†çº¢åŸºæ•°ä¸é…ç½®å¿«ç…§
  `base_amount` decimal(10,2) NOT NULL COMMENT 'åˆ†çº¢åŸºæ•°ï¼ˆé”å®šæ—¶çš„èµ„äº§ä»·å€¼ï¼‰',
  `dividend_rate` decimal(10,4) NOT NULL DEFAULT '0.0050' COMMENT 'æ—¥åˆ©ç‡å¿«ç…§ï¼ˆå¦‚0.5%ï¼‰',
  `total_days` int(11) NOT NULL DEFAULT '365' COMMENT 'åˆ†çº¢å‘¨æœŸå¤©æ•°å¿«ç…§',
  
  -- æ—¶é—´å‘¨æœŸ
  `start_time` int(11) NOT NULL COMMENT 'æ”¶ç›Šå¼€å§‹æ—¶é—´ï¼ˆæ˜å¤©å‡Œæ™¨ï¼‰',
  `end_time` int(11) NOT NULL COMMENT 'æ”¶ç›Šæˆªæ­¢æ—¶é—´',
  
  -- ç»Ÿè®¡
  `total_profit` decimal(10,2) DEFAULT '0.00' COMMENT 'ç´¯è®¡å·²äº§å‡ºæ”¶ç›Š',
  `status` tinyint(1) DEFAULT '1' COMMENT '1:ç”Ÿæ•ˆä¸­ 2:å·²åˆ°æœŸ',
  
  `create_time` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_user_status` (`user_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æƒç›Šåˆ†çº¢èŠ‚ç‚¹è¡¨';
```

### 1.6 ç³»ç»Ÿé…ç½®è¡¨ - å‚æ•°è¯´æ˜

```json
{
  "rush_base_cost": 5,              // åŸºç¡€é—¨ç¥¨æ¶ˆè€—ï¼ˆç»¿è‰²ç®—åŠ›ï¼‰
  "rush_boost_enable": 1,           // æ˜¯å¦å¼€å¯åŠ æ³¨åŠŸèƒ½ï¼ˆ1:æ˜¯ 0:å¦ï¼‰
  "rush_boost_max": 50,             // å•æ¬¡æœ€å¤§åŠ æ³¨ä¸Šé™ï¼ˆé˜²æ­¢å„æ–­ï¼‰
  "rush_boost_ratio": 10,           // åŠ æ³¨æ±‡ç‡ï¼šæ¯1ç‚¹ç®—åŠ›å¢åŠ Xæƒé‡
  
  "dividend_daily_rate": 0.005,     // åˆ†çº¢æ—¥åŒ–æ¯”ä¾‹ï¼ˆ0.5%ï¼‰
  "dividend_period_days": 365,      // åˆ†çº¢æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
  
  "exchange_rate": 2,               // å…‘æ¢æ¯”ä¾‹ï¼šNæ¶ˆè´¹é‡‘=1ç®—åŠ›
  
  "consign_fee_rate": 0.03,         // å¯„å”®æ‰‹ç»­è´¹ç‡ï¼ˆ3%ï¼‰
  "legacy_unlock_cost": 1000        // æ—§èµ„äº§è§£é”æ¶ˆè€—ï¼ˆæ—§è´¦ï¼‰
}
```

---

## äºŒã€æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### æ¨¡å—ä¸€ï¼šå•†å“ä¸Šæ¶ä¸æ•°æ®é˜²ä¼ª

#### 2.1.1 Hashç”Ÿæˆè¾…åŠ©å‡½æ•°

```php
/**
 * ç”Ÿæˆå­˜è¯æŒ‡çº¹ï¼ˆMD5ä¼ªHashï¼‰
 */
function generateAssetHash($productId) {
    $salt = env('ASSET_SALT', 'TREE_SECURE_2025');
    $timestamp = time();
    return md5($productId . $timestamp . $salt);
}

/**
 * ç”Ÿæˆç¡®æƒç¼–å·ï¼ˆ37å¼€å¤´ï¼‰
 */
function generateAssetCode($productId) {
    return '37-DATA-' . date('Ymd') . '-' . str_pad($productId, 6, '0', STR_PAD_LEFT);
}
```

#### 2.1.2 å®˜æ–¹å•†å“å‘å¸ƒ

```php
/**
 * å¹³å°å‘å¸ƒä¸€çº§å¸‚åœºèµ„äº§åŒ…
 */
public function publishProduct($data) {
    $productId = Db::name('market_products')->insertGetId([
        'name' => $data['name'],
        'price' => $data['price'],
        'session_id' => $data['session_id'],
        'status' => 1,
        'create_time' => time()
    ]);
    
    if ($productId) {
        // ç”Ÿæˆé˜²ä¼ªæ•°æ®
        Db::name('market_products')->where('id', $productId)->update([
            'tx_hash' => generateAssetHash($productId),
            'asset_code' => generateAssetCode($productId)
        ]);
    }
    
    return $productId;
}
```

#### 2.1.3 ç”¨æˆ·å¯„å”®ä¸Šæ¶

```php
/**
 * ç”¨æˆ·æŒä»“èµ„äº§æŒ‚å•
 */
public function consignAsset($user_id, $asset_id) {
    Db::startTrans();
    try {
        // 1. æ£€æŸ¥èµ„äº§å½’å±å’ŒçŠ¶æ€
        $asset = Db::name('user_collection')
            ->where('id', $asset_id)
            ->where('user_id', $user_id)
            ->lock(true)
            ->find();
            
        if (!$asset || $asset['status'] != 1) {
            throw new Exception('èµ„äº§çŠ¶æ€ä¸ç¬¦åˆä¸Šæ¶æ¡ä»¶');
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦äºŒæ¬¡ä¸Šæ¶ï¼ˆæµæ‹åé‡å‘å…è´¹ï¼‰
        $isRelist = Db::name('consign_records')
            ->where('asset_id', $asset_id)
            ->where('result', 'unsold')
            ->count() > 0;
        
        if (!$isRelist) {
            // é¦–æ¬¡ä¸Šæ¶æ”¶è´¹
            $feeRate = config('site.consign_fee_rate', 0.03);
            $fee = bcmul($asset['price'], $feeRate, 2);
            
            // æ‰£é™¤ç¡®æƒé‡‘
            User::money($user_id, -$fee, 'service_money', 'å¯„å”®æ‰‹ç»­è´¹');
            
            // æ‰£é™¤å¯„å”®åˆ¸
            User::ticket($user_id, -1, 'consign', 'æ¶ˆè€—å¯„å”®åˆ¸');
        }
        
        // 3. ä¿®æ”¹èµ„äº§çŠ¶æ€ä¸ºæŒ‚å•
        Db::name('user_collection')->where('id', $asset_id)->update([
            'status' => 2,
            'update_time' => time()
        ]);
        
        Db::commit();
        return true;
        
    } catch (Exception $e) {
        Db::rollback();
        throw $e;
    }
}
```

#### 2.1.4 å•†å“è¯¦æƒ…æ¥å£ï¼ˆå¼ºåˆ¶è„±æ•ï¼‰

```php
/**
 * APIè¾“å‡º - æ•°æ®è„±æ•
 */
public function getProductDetail($id) {
    $product = Db::name('market_products')->find($id);
    
    if (!$product) {
        return json(['code' => 404, 'msg' => 'èµ„äº§ä¸å­˜åœ¨']);
    }
    
    // å¼ºåˆ¶è¦†ç›–æ•æ„Ÿå­—æ®µï¼ˆä»£ç å±‚è„±æ•ï¼‰
    $product['supplier_name'] = 'å±±ä¸œ**ä¾›åº”é“¾ç®¡ç†æœ‰é™å…¬å¸ï¼ˆæ ¸å¿ƒä¼ä¸šï¼‰';
    $product['asset_source'] = 'æ¶‰åŠå†œæˆ·/åˆä½œç¤¾ï¼šè‹¥å¹²ï¼ˆæ•°æ®å·²è„±æ•ï¼‰';
    $product['contract_no'] = 'HT-SD-' . date('Ymd') . '-ENC';
    $product['security_status'] = 'å·²é€šè¿‡å›½å¯†ç®—æ³•(SM2)åŠ å¯†ä¸Šé“¾';
    
    return json(['code' => 200, 'data' => $product]);
}
```

---

### æ¨¡å—äºŒï¼šé¢„çº¦æ’®åˆå¼•æ“ï¼ˆæ ¸å¿ƒï¼‰

#### 2.2.1 ç«ä»·æ‘˜ç‰Œé¢„çº¦æ¥å£

```php
/**
 * POST /api/trade/reserve
 * å‚æ•°ï¼šsession_idï¼ˆåœºæ¬¡IDï¼‰, extra_hashrateï¼ˆé¢å¤–åŠ æ³¨ç®—åŠ›ï¼Œå¯é€‰ï¼‰
 */
public function reserve() {
    $sessionId = input('session_id');
    $extraHashrate = input('extra_hashrate', 0); // é»˜è®¤0ä¸åŠ æ³¨
    $userId = $this->auth->id;
    
    // 1. è¯»å–é…ç½®
    $baseCost = config('site.rush_base_cost', 5);
    $maxBoost = config('site.rush_boost_max', 50);
    $boostRatio = config('site.rush_boost_ratio', 10);
    
    // 2. å‚æ•°æ ¡éªŒ
    if ($extraHashrate < 0 || $extraHashrate > $maxBoost) {
        $this->error("åŠ æ³¨èŒƒå›´ï¼š0-{$maxBoost}ç‚¹");
    }
    
    // 3. è®¡ç®—æ€»æ¶ˆè€—å’Œæƒé‡
    $totalHashrate = $baseCost + $extraHashrate;
    $finalWeight = 100 + ($extraHashrate * $boostRatio);
    
    Db::startTrans();
    try {
        // 4. æ£€æŸ¥ç”¨æˆ·èµ„äº§
        $user = Db::name('users')->where('id', $userId)->lock(true)->find();
        
        if ($user['green_hashrate'] < $totalHashrate) {
            throw new Exception('ç»¿è‰²ç®—åŠ›ä¸è¶³ï¼Œè¯·å…ˆå…‘æ¢');
        }
        
        // ä¼°ç®—å†»ç»“é‡‘é¢ï¼ˆå‡è®¾åœºæ¬¡å‡ä»·1000ï¼‰
        $freezeAmount = 1000;
        if ($user['available_money'] < $freezeAmount) {
            throw new Exception('ä¾›åº”é“¾ä¸“é¡¹é‡‘ä¸è¶³');
        }
        
        // 5. æ‰£é™¤ç®—åŠ›ï¼ˆç›´æ¥é”€æ¯ï¼Œæ— è®ºä¸­ç­¾ä¸å¦ä¸é€€ï¼‰
        Db::name('users')->where('id', $userId)->setDec('green_hashrate', $totalHashrate);
        
        // 6. å†»ç»“ä¸“é¡¹é‡‘
        Db::name('users')->where('id', $userId)->setDec('available_money', $freezeAmount);
        
        // 7. å†™å…¥é¢„çº¦è®°å½•
        Db::name('trade_reservations')->insert([
            'user_id' => $userId,
            'session_id' => $sessionId,
            'freeze_amount' => $freezeAmount,
            'base_hashrate_cost' => $baseCost,
            'extra_hashrate_cost' => $extraHashrate,
            'weight' => $finalWeight,
            'status' => 0,
            'create_time' => time()
        ]);
        
        // 8. è®°å½•æµæ°´
        $this->logAction($userId, 'reserve', "é¢„çº¦åœºæ¬¡#{$sessionId}ï¼Œç®—åŠ›æ¶ˆè€—{$totalHashrate}");
        
        Db::commit();
        $this->success('é¢„çº¦æˆåŠŸï¼ç­‰å¾…æ’®åˆç»“æœ');
        
    } catch (Exception $e) {
        Db::rollback();
        $this->error($e->getMessage());
    }
}
```

#### 2.2.2 åŠ æƒæ’®åˆåŒ¹é…è„šæœ¬

```php
/**
 * å®šæ—¶ä»»åŠ¡ï¼šåœºæ¬¡ç»“æŸåæ‰§è¡Œæ’®åˆ
 * æ‰§è¡Œæ—¶é—´ï¼šæ¯åœºç»“æŸå5åˆ†é’Ÿï¼ˆå¦‚11:05ã€15:05ã€19:05ï¼‰
 */
public function matchSession($sessionId) {
    // 1. è·å–ä¾›éœ€æ•°æ®
    $supply = Db::name('market_products')
        ->where('session_id', $sessionId)
        ->where('status', 1)
        ->select();
    
    $demand = Db::name('trade_reservations')
        ->where('session_id', $sessionId)
        ->where('status', 0)
        ->select();
    
    $supplyCount = count($supply);
    $demandCount = count($demand);
    
    Log::info("åœºæ¬¡#{$sessionId} æ’®åˆå¼€å§‹ï¼šä¾›åº”{$supplyCount}ï¼Œéœ€æ±‚{$demandCount}");
    
    if ($demandCount == 0) {
        Log::info("æ— äººé¢„çº¦ï¼Œæµæ‹");
        return;
    }
    
    Db::startTrans();
    try {
        if ($demandCount <= $supplyCount) {
            // å…¨å‘˜ä¸­ç­¾
            foreach ($demand as $reservation) {
                $this->processWin($reservation, $supply[0]); // ç®€åŒ–é€»è¾‘
            }
        } else {
            // åŠ æƒæŠ½ç­¾
            $winners = $this->weightedRandom($demand, $supplyCount);
            foreach ($winners as $reservation) {
                $this->processWin($reservation, $supply[0]);
            }
            
            // æœªä¸­ç­¾è€…é€€æ¬¾
            $losers = array_diff_key($demand, $winners);
            foreach ($losers as $reservation) {
                $this->processLose($reservation);
            }
        }
        
        Db::commit();
        Log::info("åœºæ¬¡#{$sessionId} æ’®åˆå®Œæˆ");
        
    } catch (Exception $e) {
        Db::rollback();
        Log::error("æ’®åˆå¤±è´¥ï¼š{$e->getMessage()}");
    }
}

/**
 * åŠ æƒéšæœºç®—æ³•
 */
private function weightedRandom($candidates, $winCount) {
    $winners = [];
    $pool = [];
    
    // 1. æ„å»ºæƒé‡æ± ï¼ˆç®€åŒ–ç‰ˆï¼‰
    foreach ($candidates as $key => $user) {
        for ($i=0; $i < $user['weight']; $i++) {
            $pool[] = $key;
        }
    }
    
    // 2. éšæœºæŠ½å–
    shuffle($pool);
    $selectedKeys = array_slice(array_unique($pool), 0, $winCount);
    
    foreach ($selectedKeys as $key) {
        $winners[] = $candidates[$key];
    }
    
    return $winners;
}

/**
 * å¤„ç†ä¸­ç­¾
 */
private function processWin($reservation, $product) {
    // æ›´æ–°é¢„çº¦çŠ¶æ€
    Db::name('trade_reservations')
        ->where('id', $reservation['id'])
        ->update(['status' => 1, 'match_time' => time()]);
    
    // æ‰§è¡Œäº¤æ˜“ç»“ç®—ï¼ˆè§ä¸‹æ–‡ï¼‰
    $this->settleTransaction($reservation, $product);
    
    // å‘æ”¾å¯„å”®åˆ¸
    User::ticket($reservation['user_id'], 1, 'win_grant', 'ä¸­ç­¾å¥–åŠ±');
}

/**
 * å¤„ç†æœªä¸­ç­¾
 */
private function processLose($reservation) {
    // æ›´æ–°çŠ¶æ€
    Db::name('trade_reservations')
        ->where('id', $reservation['id'])
        ->update(['status' => 2, 'match_time' => time()]);
    
    // é€€å›å†»ç»“çš„ä¸“é¡¹é‡‘
    User::money(
        $reservation['user_id'],
        $reservation['freeze_amount'],
        'available_money',
        'æœªä¸­ç­¾é€€å›'
    );
    
    // ç®—åŠ›ä¸é€€ï¼
}
```

---

### æ¨¡å—ä¸‰ï¼šäº¤æ˜“ç»“ç®—ä¸åˆ†æ¶¦

```php
/**
 * äº¤æ˜“æˆäº¤ç»“ç®—ï¼ˆèµ„é‡‘æµè½¬æ ¸å¿ƒï¼‰
 */
private function settleTransaction($reservation, $product) {
    $buyerId = $reservation['user_id'];
    $sellerId = $product['owner_id'] ?: 0; // 0è¡¨ç¤ºå¹³å°
    $sellPrice = $product['price'];
    
    // 1. æ£€æŸ¥æ˜¯å¦ä¸ºæ—§èµ„äº§é¦–æ¬¡äº¤æ˜“
    $asset = Db::name('user_collection')
        ->where('id', $product['asset_id'])
        ->find();
    
    $isLegacyFirstSale = ($asset && $asset['is_legacy_unlock'] == 1);
    
    Db::startTrans();
    try {
        if ($isLegacyFirstSale) {
            // ===== æ—§èµ„äº§é¦–æ¬¡å˜ç°é€»è¾‘ =====
            $cashIncome = bcmul($sellPrice, 0.5, 2);   // 500å…ƒ
            $scoreIncome = bcmul($sellPrice, 0.5, 2);  // 500åˆ†
            
            User::money($sellerId, $cashIncome, 'withdraw_money', 'æ—§èµ„äº§å˜ç°-æ”¶ç›Š');
            User::score($sellerId, $scoreIncome, 'legacy_split', 'æ—§èµ„äº§å˜ç°-æ¶ˆè´¹é‡‘');
            
            // æ´—ç™½èµ„äº§
            Db::name('user_collection')
                ->where('id', $product['asset_id'])
                ->update(['is_legacy_unlock' => 0]);
                
        } else {
            // ===== æ­£å¸¸äº¤æ˜“é€»è¾‘ =====
            $buyCost = $asset['original_cost'] ?: $sellPrice; // ä¹°å…¥æˆæœ¬
            $profit = bcsub($sellPrice, $buyCost, 2);
            
            $profitHalf = bcmul($profit, 0.5, 2);
            $totalCashback = bcadd($buyCost, $profitHalf, 2); // æœ¬é‡‘+50%åˆ©
            
            User::money($sellerId, $totalCashback, 'withdraw_money', 'èµ„äº§äº¤å‰²å›æ¬¾');
            User::score($sellerId, $profitHalf, 'trade_profit', 'æµè½¬æ”¶ç›Šåˆ†æˆ');
        }
        
        // 2. åˆ’æ‰£ä¹°å®¶èµ„é‡‘
        User::money($buyerId, -$sellPrice, 'available_money', 'æˆäº¤æ‰£æ¬¾');
        
        // 3. èµ„äº§è½¬ç§»
        Db::name('user_collection')->insert([
            'user_id' => $buyerId,
            'product_id' => $product['id'],
            'name' => $product['name'],
            'price' => $sellPrice,
            'original_cost' => $sellPrice,
            'status' => 1,
            'create_time' => time()
        ]);
        
        // 4. å•†å“çŠ¶æ€æ›´æ–°
        Db::name('market_products')
            ->where('id', $product['id'])
            ->update(['status' => 3, 'sold_time' => time()]);
        
        Db::commit();
        
    } catch (Exception $e) {
        Db::rollback();
        throw $e;
    }
}
```

---

## ä¸‰ã€ç®—åŠ›ç»æµæ¨¡å‹

### 3.1 ç»¿è‰²ç®—åŠ›å…‘æ¢æ¥å£

```php
/**
 * POST /api/exchange/hashrate
 * æ¶ˆè€—æ¶ˆè´¹é‡‘å…‘æ¢ç»¿è‰²ç®—åŠ›
 */
public function exchangeHashrate() {
    $amount = input('amount'); // æ¶ˆè€—æ¶ˆè´¹é‡‘æ•°é‡
    $userId = $this->auth->id;
    
    $rate = config('site.exchange_rate', 2); // 2æ¶ˆè´¹é‡‘=1ç®—åŠ›
    $gain = bcdiv($amount, $rate, 2);
    
    Db::startTrans();
    try {
        $user = Db::name('users')->where('id', $userId)->lock(true)->find();
        
        if ($user['score'] < $amount) {
            throw new Exception('æ¶ˆè´¹é‡‘ä½™é¢ä¸è¶³');
        }
        
        // æ‰£é™¤æ¶ˆè´¹é‡‘
        Db::name('users')->where('id', $userId)->setDec('score', $amount);
        
        // å¢åŠ ç®—åŠ›
        Db::name('users')->where('id', $userId)->setInc('green_hashrate', $gain);
        
        // è®°å½•æµæ°´
        $this->logAction($userId, 'exchange_hashrate', "æ¶ˆè€—{$amount}æ¶ˆè´¹é‡‘ï¼Œè·å¾—{$gain}ç®—åŠ›");
        
        Db::commit();
        $this->success("å…‘æ¢æˆåŠŸï¼è·å¾—{$gain}ç»¿è‰²ç®—åŠ›");
        
    } catch (Exception $e) {
        Db::rollback();
        $this->error($e->getMessage());
    }
}
```

### 3.2 ç®—åŠ›æƒé‡è®¡ç®—å…¬å¼

```
æœ€ç»ˆæƒé‡ = 100 + (é¢å¤–åŠ æ³¨ç®—åŠ› Ã— æƒé‡ç³»æ•°)

ç¤ºä¾‹ï¼ˆç³»æ•°=10ï¼‰ï¼š
- ç”¨æˆ·Aï¼šåªäº¤5ç‚¹é—¨ç¥¨ â†’ æƒé‡100
- ç”¨æˆ·Bï¼šé—¨ç¥¨5+åŠ æ³¨10 â†’ æƒé‡100+(10Ã—10)=200
- ç”¨æˆ·Cï¼šé—¨ç¥¨5+åŠ æ³¨50 â†’ æƒé‡100+(50Ã—10)=600

ç»“è®ºï¼šç”¨æˆ·Cçš„ä¸­ç­¾æ¦‚ç‡æ˜¯ç”¨æˆ·Açš„6å€
```

---

## å››ã€èµ„é‡‘æµè½¬é—­ç¯

### 4.1 èµ„é‡‘å››åº“éš”ç¦»

| è´¦æˆ·åç§° | å­—æ®µå | ä¸šåŠ¡ç”¨é€” | èµ„é‡‘æ¥æº | å¯å¦æç° |
|---------|--------|---------|---------|---------|
| ä¾›åº”é“¾ä¸“é¡¹é‡‘ | available_money | æŠ¢è´­æœ¬é‡‘ | å……å€¼ | âŒ å¦ |
| å¯è°ƒåº¦æ”¶ç›Š | withdraw_money | å›æ¬¾æ”¶ç›Š | å–è´§ | âœ… æ˜¯ |
| ç¡®æƒé‡‘ | service_money | æ‰‹ç»­è´¹ | åˆ’è½¬ | âŒ å¦ |
| æ¶ˆè´¹é‡‘ | score | å†…å¾ªç¯é€šè¯ | åˆ©æ¶¦åˆ†æˆ | âŒ å¦ï¼ˆå¯å…‘æ¢ç®—åŠ›ï¼‰|

### 4.2 å……å€¼å›è°ƒé€»è¾‘

```php
/**
 * çº¿ä¸‹å……å€¼å®¡æ ¸é€šè¿‡å›è°ƒ
 * é‡è¦ï¼šå¿…é¡»å¢åŠ åˆ° available_money
 */
public function rechargeCallback($orderId) {
    Db::startTrans();
    try {
        $order = Db::name('recharge_orders')
            ->where('id', $orderId)
            ->lock(true)
            ->find();
        
        if (!$order || $order['status'] != 0) {
            throw new Exception('è®¢å•çŠ¶æ€å¼‚å¸¸');
        }
        
        // å¢åŠ åˆ°ä¾›åº”é“¾ä¸“é¡¹é‡‘
        User::money($order['user_id'], $order['amount'], 'available_money', 'ä¸“é¡¹é‡‘ç”³è´­');
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        Db::name('recharge_orders')
            ->where('id', $orderId)
            ->update(['status' => 1, 'pay_time' => time()]);
        
        Db::commit();
        Log::info("å……å€¼æˆåŠŸï¼šç”¨æˆ·#{$order['user_id']}ï¼Œé‡‘é¢{$order['amount']}");
        
    } catch (Exception $e) {
        Db::rollback();
        Log::error("å……å€¼å›è°ƒå¤±è´¥ï¼š{$e->getMessage()}");
    }
}
```

---

## äº”ã€æ—§èµ„äº§è§£é”æœºåˆ¶

### 5.1 è§£é”æ¡ä»¶æ£€æµ‹

```php
/**
 * æ£€æµ‹ç”¨æˆ·æ˜¯å¦æ»¡è¶³è§£é”æ¡ä»¶
 * æ¡ä»¶ï¼šè‡ªèº«äº¤æ˜“ç”¨æˆ· + ç›´æ¨3ä¸ªäº¤æ˜“ç”¨æˆ·
 */
public function checkUnlockCondition($userId) {
    // 1. æ£€æŸ¥è‡ªå·±æ˜¯å¦æœ‰äº¤æ˜“è®°å½•
    $selfTrade = Db::name('trade_orders')
        ->where('buyer_id|seller_id', $userId)
        ->count() > 0;
    
    if (!$selfTrade) {
        return false;
    }
    
    // 2. æ£€æŸ¥ç›´æ¨çš„æœ‰äº¤æ˜“ç”¨æˆ·æ•°
    $activeReferrals = Db::name('users')
        ->alias('u')
        ->join('trade_orders o', 'o.buyer_id = u.id OR o.seller_id = u.id')
        ->where('u.referrer_id', $userId)
        ->group('u.id')
        ->count();
    
    return $activeReferrals >= 3;
}
```

### 5.2 è§£é”åŒ…å‘æ”¾

```php
/**
 * å‘æ”¾æ—§èµ„äº§è§£é”åŒ…
 */
public function grantLegacyAsset($userId) {
    $unlockCost = config('site.legacy_unlock_cost', 1000);
    
    Db::startTrans();
    try {
        // 1. æ£€æŸ¥æ—§è´¦ä½™é¢
        $user = Db::name('users')->where('id', $userId)->lock(true)->find();
        
        if ($user['legacy_frozen'] < $unlockCost) {
            throw new Exception('å¾…æ¿€æ´»ç¡®æƒé‡‘ä¸è¶³');
        }
        
        // 2. æ‰£é™¤æ—§è´¦
        Db::name('users')->where('id', $userId)->setDec('legacy_frozen', $unlockCost);
        
        // 3. å‘æ”¾èµ„äº§åŒ…ï¼ˆæ ‡è®°ä¸ºæ—§èµ„äº§ï¼‰
        $assetId = Db::name('user_collection')->insertGetId([
            'user_id' => $userId,
            'name' => 'ã€æƒç›Šå¤è‹ã€‘å­˜é‡æ•°æ®ç¡®æƒåŒ… #' . mt_rand(1000, 9999),
            'price' => $unlockCost,
            'original_cost' => 0, // æ— æœ¬é‡‘æˆæœ¬
            'is_legacy_unlock' => 1, // æ ‡è®°é‡ç‚¹
            'status' => 1,
            'create_time' => time()
        ]);
        
        // 4. å‘æ”¾å¯„å”®åˆ¸
        User::ticket($userId, 1, 'legacy_grant', 'è§£é”èµ é€');
        
        $this->logAction($userId, 'unlock_legacy', "è§£é”èµ„äº§åŒ…#{$assetId}");
        
        Db::commit();
        return $assetId;
        
    } catch (Exception $e) {
        Db::rollback();
        throw $e;
    }
}
```

### 5.3 æ—§èµ„äº§é¦–æ¬¡äº¤æ˜“ç‰¹æ®Šå¤„ç†

**å·²åœ¨ã€æ¨¡å—ä¸‰ï¼šäº¤æ˜“ç»“ç®—ã€‘ä¸­å®ç°ï¼Œæ ¸å¿ƒé€»è¾‘ï¼š**

1. æ£€æŸ¥ `is_legacy_unlock` æ ‡è®°
2. è‹¥ä¸ºé¦–æ¬¡å–å‡ºï¼š500è¿›å¯è°ƒåº¦æ”¶ç›Š + 500è¿›æ¶ˆè´¹é‡‘
3. æ´—ç™½èµ„äº§ï¼ˆ`is_legacy_unlock = 0`ï¼‰
4. ä¹°å®¶åç»­æŒ‰æ­£å¸¸äº¤æ˜“å¤„ç†

---

## å…­ã€å®šæ—¶ä»»åŠ¡

### 6.1 æ¯æ—¥åˆ†çº¢å‘æ”¾

```bash
# Crontab é…ç½®
0 1 * * * php /path/to/think dividend daily
```

```php
/**
 * æ¯æ—¥åˆ†çº¢å‘æ”¾è„šæœ¬
 */
public function dailyDividend() {
    $now = time();
    
    $nodes = Db::name('user_dividend_nodes')
        ->where('status', 1)
        ->where('start_time', '<=', $now)
        ->where('end_time', '>', $now)
        ->select();
    
    foreach ($nodes as $node) {
        try {
            // è®¡ç®—å½“æ—¥æ”¶ç›Š
            $dailyProfit = bcmul($node['base_amount'], $node['dividend_rate'], 2);
            
            // 50%è¿›å¯è°ƒåº¦æ”¶ç›Šï¼Œ50%è¿›æ¶ˆè´¹é‡‘
            $cash = bcmul($dailyProfit, 0.5, 2);
            $score = bcmul($dailyProfit, 0.5, 2);
            
            User::money($node['user_id'], $cash, 'withdraw_money', 'æƒç›Šåˆ†çº¢-æ”¶ç›Š');
            User::score($node['user_id'], $score, 'dividend_score', 'æƒç›Šåˆ†çº¢-æ¶ˆè´¹é‡‘');
            
            // è®°å½•ç´¯è®¡æ”¶ç›Š
            Db::name('user_dividend_nodes')
                ->where('id', $node['id'])
                ->setInc('total_profit', $dailyProfit);
            
            Log::info("åˆ†çº¢å‘æ”¾ï¼šèŠ‚ç‚¹#{$node['id']}ï¼Œé‡‘é¢{$dailyProfit}");
            
        } catch (Exception $e) {
            Log::error("åˆ†çº¢å¤±è´¥ï¼šèŠ‚ç‚¹#{$node['id']}ï¼Œ{$e->getMessage()}");
        }
    }
    
    // å¤„ç†è¿‡æœŸèŠ‚ç‚¹
    Db::name('user_dividend_nodes')
        ->where('end_time', '<=', $now)
        ->where('status', 1)
        ->update(['status' => 2]);
}
```

### 6.2 æ’®åˆä»»åŠ¡è°ƒåº¦

```bash
# æ—©åœºæ’®åˆï¼ˆ11:05ï¼‰
5 11 * * * php /path/to/think match session --id=1

# åˆåœºæ’®åˆï¼ˆ15:05ï¼‰
5 15 * * * php /path/to/think match session --id=2

# æ™šåœºæ’®åˆï¼ˆ19:05ï¼‰
5 19 * * * php /path/to/think match session --id=3
```

---

## ä¸ƒã€å¼€å‘æ³¨æ„äº‹é¡¹

### 7.1 æ•°æ®ä¸€è‡´æ€§

âœ… **ç¡®æƒHashä¸€æ—¦ç”Ÿæˆä¸å¯ä¿®æ”¹**  
âœ… **åˆ†çº¢èŠ‚ç‚¹çš„åˆ©ç‡/å¤©æ•°æŒ‰åˆ›å»ºæ—¶å¿«ç…§ï¼Œä¸å—åç»­é…ç½®å½±å“**  
âœ… **æ—§èµ„äº§æ ‡è®°å¿…é¡»åœ¨é¦–æ¬¡äº¤æ˜“åæ¸…é™¤**

### 7.2 å¹¶å‘æ§åˆ¶

âš ï¸ **é¢„çº¦æ¥å£å¿…é¡»å¯¹ç”¨æˆ·IDåŠ é”ï¼ˆRedisåˆ†å¸ƒå¼é”ï¼‰**  
âš ï¸ **æ’®åˆè„šæœ¬å¿…é¡»ç¡®ä¿å•å®ä¾‹æ‰§è¡Œï¼ˆé˜²æ­¢é‡å¤æ’®åˆï¼‰**  
âš ï¸ **æ‰€æœ‰èµ„é‡‘æ“ä½œå¿…é¡»ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡**

### 7.3 èµ„é‡‘éš”ç¦»çº¢çº¿

âŒ **å……å€¼ä¸¥ç¦è¿›å…¥ withdraw_money**  
âŒ **æç°ä¸¥ç¦ä» available_money æ‰£é™¤**  
âŒ **ä¸åŒèµ„é‡‘æ± ä¸¥ç¦ç›¸äº’è½¬è´¦ï¼ˆé™¤éæ˜ç¡®çš„ä¸šåŠ¡è§„åˆ™ï¼‰**

### 7.4 ç®—åŠ›æœºåˆ¶

ğŸ”¥ **ç®—åŠ›æ¶ˆè€—åä¸é€€è¿˜ï¼ˆæ— è®ºä¸­ç­¾ä¸å¦ï¼‰- æ ¸å¿ƒæ¶ˆæ³¡æœºåˆ¶**  
ğŸ”¥ **åŠ æ³¨å¿…é¡»è®¾ç½®ä¸Šé™ï¼ˆé˜²æ­¢å„æ–­ï¼‰**  
ğŸ”¥ **æƒé‡è®¡ç®—ç²¾åº¦ï¼šæ•´æ•°è¿ç®—ï¼Œé¿å…æµ®ç‚¹è¯¯å·®**

### 7.5 æ€§èƒ½ä¼˜åŒ–

ğŸ“Š **åŠ æƒéšæœºç®—æ³•ï¼šå‚ä¸äººæ•°>1000æ—¶ï¼Œä½¿ç”¨åŒºé—´äºŒåˆ†æ³•**  
ğŸ“Š **æ•°æ®åº“ç´¢å¼•ï¼šsession_id, user_id, status ç»„åˆç´¢å¼•**  
ğŸ“Š **Redisç¼“å­˜ï¼šåœºæ¬¡é…ç½®ã€ç”¨æˆ·ä½™é¢çƒ­æ•°æ®**

### 7.6 æ—¥å¿—ä¸ç›‘æ§

ğŸ“ **å…³é”®æ“ä½œå¿…é¡»è®°å½•æ—¥å¿—ï¼ˆå……å€¼ã€æç°ã€æ’®åˆã€åˆ†çº¢ï¼‰**  
ğŸ“ **æ’®åˆè„šæœ¬å¿…é¡»ç›‘æ§æ‰§è¡ŒçŠ¶æ€ï¼ˆå¦‚å¤±è´¥å‘é€å‘Šè­¦ï¼‰**  
ğŸ“ **èµ„é‡‘å¼‚å¸¸å¿…é¡»å®æ—¶æŠ¥è­¦ï¼ˆå¦‚ä½™é¢ä¸ºè´Ÿï¼‰**

---

## å…«ã€APIé”™è¯¯ç è§„èŒƒ

```
200  - æˆåŠŸ
400  - å‚æ•°é”™è¯¯
401  - æœªç™»å½•
403  - æƒé™ä¸è¶³
404  - èµ„æºä¸å­˜åœ¨
500  - æœåŠ¡å™¨é”™è¯¯

è‡ªå®šä¹‰é”™è¯¯ç ï¼ˆcode=-1ï¼Œæºå¸¦ error_typeï¼‰ï¼š
HASHRATE_INSUFFICIENT  - ç»¿è‰²ç®—åŠ›ä¸è¶³
MONEY_INSUFFICIENT     - èµ„é‡‘ä¸è¶³
STATUS_ERROR           - çŠ¶æ€å¼‚å¸¸
CONDITION_NOT_MET      - æ¡ä»¶ä¸æ»¡è¶³ï¼ˆå¦‚è§£é”æ¡ä»¶ï¼‰
BOOST_EXCEED_LIMIT     - åŠ æ³¨è¶…å‡ºä¸Šé™
SESSION_CLOSED         - åœºæ¬¡å·²ç»“æŸ
```

---

## ä¹ã€ä¸šåŠ¡æµç¨‹å›¾

```mermaid
graph TD
    A[ç”¨æˆ·å……å€¼] -->|å®¡æ ¸é€šè¿‡| B(è·å¾—:ä¾›åº”é“¾ä¸“é¡¹é‡‘)
    
    C[å‡†å¤‡ç«ä»·] --> D{æ˜¯å¦åŠ æ³¨æé«˜å‡ ç‡?}
    D --æ™®é€š--> E[æ¶ˆè€—5ç®—åŠ›/æƒé‡100]
    D --åŠ æ³¨--> F[æ¶ˆè€—5+Nç®—åŠ›/æƒé‡100+10N]
    
    E --> G[è¿›å…¥æ’®åˆæ± ]
    F --> G
    
    H[åœºæ¬¡ç»“æŸ/ç³»ç»Ÿæ’®åˆ] --> I[åŠ æƒè½®ç›˜èµŒ]
    I --> J{æ˜¯å¦ä¸­ç­¾?}
    
    J --æœªä¸­ç­¾--> K[æœ¬é‡‘é€€å›/ç®—åŠ›é”€æ¯]
    J --ä¸­ç­¾--> L[äº¤æ˜“æˆäº¤]
    
    L -->|å–å®¶| M[æœ¬é‡‘+50%åˆ©â†’å¯è°ƒåº¦æ”¶ç›Š<br/>50%åˆ©â†’æ¶ˆè´¹é‡‘]
    L -->|ä¹°å®¶| N[è·å¾—æ•°å­—èµ„äº§]
    
    N --> O{ç”¨æˆ·å†³ç­–}
    O --å˜ç°--> P[æ¬¡æ—¥ä¸Šæ¶] --> H
    O --èººå¹³--> Q[æƒç›Šäº¤å‰²]
    
    Q --> R[æ¯æ—¥åˆ†çº¢:<br/>50%æ”¶ç›Š+50%æ¶ˆè´¹é‡‘]
```

---

**æ–‡æ¡£ç»“æŸ - ä¸¥æ ¼æŒ‰æ­¤æ–‡æ¡£æ‰§è¡Œå¼€å‘**

**ç»´æŠ¤äººï¼š** åç«¯å¼€å‘ç»„  
**å®¡æ ¸äººï¼š** æŠ€æœ¯è´Ÿè´£äºº  
**æœ€åæ›´æ–°ï¼š** 2025-12-12

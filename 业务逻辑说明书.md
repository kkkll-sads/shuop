# 树交所 (TreeEx) 后端核心业务逻辑说明书

**文档版本**: v7.0  
**适用范围**: 产品经理、后端开发、测试工程师、运营配置  
**核心目标**: 构建一个闭环的数字资产确权、流转、分润及兜底生态

---

## 一、账户与钱包体系

系统建立四类独立资金账户，严格控制资金流向，杜绝混用。

### 1.1 钱包定义与流向

| 钱包名称 | 资金来源 (In) | 资金用途 (Out) | 业务属性 |
|---------|--------------|---------------|---------|
| **可用余额** | 用户充值、活动赠送 | 购买交易商品、划转至服务费余额 | 本金账户，用于进货抢单 |
| **提现余额** | 交易利润(50%)、直/间推奖、注册/签到奖 | 购买交易商品、申请提现、划转至服务费余额 | 收益账户，用户真正赚到的钱 |
| **服务费余额** | 从"可用余额"或"提现余额"划转 | 仅用于挂单扣除 | 消耗账户，不可提现，专款专用 |
| **拓展余额** | 代理商团队级差奖、平级奖 | 申请提现 | 工资账户，代理商专属 |
| **积分账户** | 交易利润(50%)、分红收益(50%) | 商城兑换、抽奖 | 沉淀账户，不可提现 |

### 1.2 服务费充值逻辑补充

**问题**: 用户如何获得服务费余额？

**解决方案**: 在"资产"页面提供【划转】功能：
- 允许用户将"可用余额"或"提现余额"以 **1:1比例** 划转为"服务费余额"
- 操作不可逆，划转后仅用于上架扣费

---

## 二、用户身份与代理体系

### 2.1 用户等级

系统依据购买行为划分等级，作为权限判定的核心依据：

- **新用户**: 仅注册实名，未产生交易
- **普通用户**: 完成第 1 笔购买（含新手/体验区）
- **交易用户**: 完成第 2 笔购买

> **关键作用**: 解锁旧资产任务的统计指标、代理升级考核的统计指标、获得寄售券的门槛

### 2.2 代理商晋升机制

系统监听"交易用户"数量变动，自动计算代理等级：

| 等级 | 比例 | 晋升条件 |
|------|------|---------|
| L1 | 9% | 认证通过 + 团队内有 **16个** 交易用户 |
| L2 | 12% | 团队有 **61个** 交易用户 **或** 直推 **3个** L1 |
| L3 | 15% | 团队有 **201个** 交易用户 **或** 直推 **3个** L2 |
| L4 | 18% | 直推 **3个** L3 |
| L5 | 21% | 直推 **3个** L4 |

> **注**: 团队统计范围为无限代

### 2.3 代理特权

**费用折扣**: 代理商上架寄售商品时，需缴纳的 3% 服务费可根据等级享受折扣（如 L5 打5折，具体后台配置）

### 2.4 代理降级机制（可选）

**当前策略**: 暂时不做自动降级，以免引发团队长不满  
**预留方案**: 后台人工降级接口

---

## 三、旧资产确权与解锁

### 3.1 申报流程

1. **前端**: 用户提交旧平台截图、申报金额
2. **后台**: 管理员审核
3. **入库**: 审核通过后，金额写入数据库字段 【待激活确权金】，状态为冻结

### 3.2 解锁任务 (1+3模型)

用户需同时满足以下条件，触发解锁事件：

- **自身**: 升级为 **交易用户**
- **推荐**: 直推下级中，有 **3人** 升级为 **交易用户**

### 3.3 奖励与变现闭环

**发放**: 任务完成后，系统发放：
- 1个「数字确权包」（价值1000元）
- 1张 寄售券
- **同时扣除**: 从用户的【待激活确权金】中扣除 **1000元**

**变现**: 用户上架该确权包

**成交结算**:
1. 买家付款后，卖家（旧用户）的 **1000元本金销毁**
2. 卖家获得的利润（如60元），**50%** 进提现余额，**50%** 进积分

**定价规则补充**:
- 该确权包在上架时，必须强制归类到 **1K区**
- 初始价格严格设定为 **1000.00元**，不能自定义价格

> **注**: 该确权包被买家买走后，即变为普通商品，后续流转遵循正常规则

---

## 四、核心交易引擎

### 4.1 基础规则

- **场次**: 10:00-11:00 / 14:00-15:00 / 19:00-20:00（非开放时间只读）
- **分区**: 1K / 2K / 3K / 4K 区（严格校验价格区间）
- **增值**: 每次成交后，价格上涨 **4% ~ 6%**（随机，保留2位小数）

### 4.2 买入流程 (Buy)

1. **扣款**: 优先扣"可用余额"，不足扣"提现余额"
2. **权益**: 仅 **交易用户** 购买成功后赠送 1张 寄售券（对应分区，有效期7天）
   - 新用户/普通用户购买不赠送寄售券
3. **状态**: 商品进入【待寄售】状态

### 4.3 寄售/上架流程 (Sell)

#### 场景A：首次上架
- **扣费**: 扣除 3% 服务费（从服务费余额） + 1张 寄售券
- **校验**: 余额/券不足拦截上架

#### 场景B：失败后重发
- **免费**: 判定为"重发单"，不扣服务费，不扣寄售券

#### 场景C：挂单中不可转分红
- 如果商品状态为"挂单中"，不能点击"转入分红"
- 必须先执行"撤单"操作，商品回到"待寄售"状态后，方可转分红

### 4.4 结算流程 (Settlement)

交易完成（买家确认收货）后：

1. **本金**: 全额返还
2. **利润**: 50% 进提现余额，50% 进积分
3. **触发**: 立即触发佣金结算

---

## 五、资产分红与熔断体系

资产转为"永久分红节点"分为被动和主动两种路径。

### 5.1 被动熔断 (Fail-Safe)

满足任一条件，商品强制转为分红节点：

- 连续 **5次** 流拍
- 持有超过 **7天** 未操作
- 现价超过发行价 **7倍**

### 5.2 主动转分红 (Manual Staking)

**操作**: 用户在【待寄售】状态下，手动点击"转入分红"

**校验**:
- 需二次确认，操作不可逆
- 商品不能处于"挂单中"状态

**结果**:
- 商品销毁，价值全额计入分红算力
- 从交易流通表中移除，标记为"已手动锁定"

### 5.3 分红收益

- **来源**: 虚拟增发（平台统一配置）
- **发放**: 每日凌晨结算
- **分配**: 收益的 **50%** 进提现余额，**50%** 进积分

---

## 六、佣金与代理分润体系

> **核心基数**: 仅基于卖家的 **纯利润** 计算

### 6.1 基础推荐奖

| 类型 | 比例 | 去向 |
|------|------|------|
| 直推 | 利润 × 10% | 提现余额 |
| 间推 | 利润 × 5% | 提现余额 |

### 6.2 代理团队级差奖 (Differential)

**逻辑**: 无限代，自下而上遍历，级差扣减

**公式**: `(我的等级比例 - 下级已拨出比例) × 利润`

**去向**: 拓展余额

#### 计算流程

系统从卖家的直接推荐人开始，向上追溯关系链：

```
变量定义：
- Total_Profit: 本单卖家利润
- Allocated_Rate: 已拨出的比例（初始为0）

遍历流程：
1. 获取上级 Node
2. 判断是否为代理商
3. 计算级差奖：
   IF Node.Level_Rate > Allocated_Rate:
       奖励 = Total_Profit × (Node.Level_Rate - Allocated_Rate)
       更新 Allocated_Rate = Node.Level_Rate
       发放至"拓展余额"
   ELSE:
       无级差奖
4. 循环至最高级（21%）或无上级
```

### 6.3 代理同级/平级奖 (Same-Level)

**触发条件**: 当 上级代理等级 == 下级代理等级（且该等级 > 0）

**计算基数**: 基于 **下级代理刚刚获得的级差奖金额**

**公式**: `平级奖 = 下级获得的级差金额 × 10%`

**限制**: 通常仅发一代（即只给紧邻的上级）

**去向**: 拓展余额

#### 场景演算案例

假设：卖家产生利润 **100元**  
关系链：用户 -> A(L1) -> B(L2) -> C(L2) -> D(L3) -> E(L5)

| 代理 | 等级 | 比例 | 级差奖 | 平级奖 | 说明 |
|------|------|------|--------|--------|------|
| A | L1 | 9% | 9元 | - | 100 × (9% - 0%) |
| B | L2 | 12% | 3元 | - | 100 × (12% - 9%) |
| C | L2 | 12% | 0元 | 0.3元 | 与B同级，获得B的10% |
| D | L3 | 15% | 3元 | - | 100 × (15% - 12%) |
| E | L5 | 21% | 6元 | - | 100 × (21% - 15%) |

**合计**: 9 + 3 + 0.3 + 3 + 6 = **21.3元**

---

## 七、数据字典速查

| 参数项 | 数值/规则 | 说明 |
|--------|----------|------|
| 交易服务费 | 3% | 基数为商品当前价 |
| 寄售券有效期 | 7天 | 获得后7天未使用自动作废 |
| 增值幅度 | 4% - 6% | 随机生成，平均 5.5% |
| 利润分配 | 5:5 | 50%提现余额 : 50%积分 |
| 熔断阈值 | 5次 / 7天 / 7倍 | 触发转静态分红 |
| 旧资产解锁包 | 1000元 | 交易成功后本金销毁 |
| 代理比例 | 9% - 21% | 3%递增 |
| 注册奖 | 2.88元 | 进提现余额 |

---

## 八、技术风控要点

### 8.1 并发锁机制 (关键)

在以下环节必须加数据库行锁或 Redis 锁：

- **购买**: 防止一个商品被两个人同时买走（超卖）
- **上架**: 防止一张寄售券被用了两次（双花）

### 8.2 数据一致性

- 所有资金变动必须有流水记录
- 分润计算结果需要可追溯审计
- 用户等级变更需要触发事件通知

### 8.3 异常处理

- 支付失败的回滚机制
- 分润计算失败的补偿机制
- 熔断触发的数据备份

---

## 九、逻辑缺口自查清单

以下逻辑建议在开发时一并补齐：

- [x] **服务费充值逻辑**: 已补充划转功能说明
- [x] **旧资产确权包定价**: 已明确1K区+1000元固定价
- [x] **手动转分红撤销**: 已明确需先撤单才能转分红
- [ ] **代理降级机制**: 建议暂不自动降级，预留人工接口
- [x] **并发锁**: 已明确购买和上架需加锁

---

## 十、业务流程总图

```
用户注册 -> 实名认证 -> 新用户
    |
    v
首次购买 -> 普通用户 -> 获得寄售券
    |
    v
二次购买 -> 交易用户 -> 解锁旧资产 / 代理考核
    |
    v
寄售上架 -> 扣服务费 + 券 -> 挂单中
    |
    v
交易成功 -> 利润分配 -> 触发分润计算
    |               |
    v               v
 50%提现余额    50%积分
    |
    v
熔断/手动 -> 永久分红节点 -> 每日静态收益
```

---

**文档更新日期**: 2025-12-09  
**维护责任人**: 产品&技术团队  
**下次更新**: 根据业务迭代实时更新
